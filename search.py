import pandas as pd
import openpyxl
import requests
import argparse
import pytz
import json
import time
import csv
import sys
import os
from datetime import datetime, timedelta

global csvwrite
global k

def getApiKey():  # retrieves API_KEY for NVD
    # api_txt = open('api_key.txt','r')
    # API_KEY = api_txt.read()
    # api_txt.close()
    API_KEY = os.getenv("NVD_API_KEY")
    return API_KEY


def kwSearch(keywords, mTrig=False):  # Searching NVD API for keywords
    print("Searching for New/Modified CVEs for " + str(keywords))
    time = datetime.now().strftime("%Y-%m-%dT%H:%M:%S.%fZ")
    delta = datetime.now() - timedelta(days=7)  # Only Modified since last week
    lastweek = delta.strftime("%Y-%m-%dT%H:%M:%S.%fZ")
    url = "https://services.nvd.nist.gov/rest/json/cves/2.0/"
    headers = {"apiKey": getApiKey()}
    params = {
        "keywordSearch": keywords,
        "lastModStartDate": lastweek,
        "lastModEndDate": time,
    }
    if mTrig:
        params.update({"resultsPerPage": "5"})  # If mTrig is True, trigger Mini Mode
    r = requests.get(url, headers=headers, params=params)
    try:
        cves = r.json()
        for cve in cves["vulnerabilities"]:
            c = cve["cve"]
            print(str(c["id"]))
            # print(
            # "CVE: " + str(c['id']) + "\n"
            # "Last Modified: " + str(c['lastModified']) + "\n"
            # "Description: " + str(c['descriptions'][0]['value'])
            # )
            if "cvssMetricV31" in c["metrics"]:
                # print("Impact Score V31: " + str(c['metrics']['cvssMetricV31'][0]['impactScore']) + "\n")
                csvwrite.writerow(
                    [
                        str(c["id"]),
                        str(c["metrics"]["cvssMetricV31"][0]["impactScore"]),
                        str(k),
                        str(c["descriptions"][0]["value"]),
                        str(c["lastModified"]),
                    ]
                )
            elif "cvssMetricV30" in c["metrics"]:
                # print("Impact Score V2: " + str(c['metrics']['cvssMetricV30'][0]['impactScore']) + "\n")
                csvwrite.writerow(
                    [
                        str(c["id"]),
                        str(c["metrics"]["cvssMetricV30"][0]["impactScore"]),
                        str(k),
                        str(c["descriptions"][0]["value"]),
                        str(c["lastModified"]),
                    ]
                )
            elif "cvssMetricV2" in c["metrics"]:
                # print("Impact Score V2: " + str(c['metrics']['cvssMetricV2'][0]['impactScore']) + "\n")
                csvwrite.writerow(
                    [
                        str(c["id"]),
                        str(c["metrics"]["cvssMetricV2"][0]["impactScore"]),
                        str(k),
                        str(c["descriptions"][0]["value"]),
                        str(c["lastModified"]),
                    ]
                )
            else:
                # continue
                csvwrite.writerow(
                    [
                        str(c["id"]),
                        str("N/A"),
                        str(k),
                        str(c["descriptions"][0]["value"]),
                        str(c["lastModified"]),
                    ]
                )
            # print(c)
        # print(cves)
    except:
        print("Error: ", keywords, " ", r.status_code)  # exception for bad API requests


def csvWriter(mTrig=False):  # CSV creator
    print("Writing CSV")
    csvfile = open("cve.csv", mode="w", newline="")
    global csvwrite
    csvwrite = csv.writer(
        csvfile,
        dialect="excel",
        delimiter=",",
        quotechar='"',
        quoting=csv.QUOTE_MINIMAL,
    )
    csvwrite.writerow(["CVE", "Impact Score (1-10, 10 being the worst)", "Keyword", "Description", "Last Modified"])
    # csvwrite.writerow(['1234','1.2','test description','11-1-11'])
    global k
    for k in kwArray:
        if mTrig:
            kwSearch(k, mTrig)
            time.sleep(6)
        else:
            kwSearch(k)
            time.sleep(6)
    csvfile.close()


def dupeCheck():
    print("Eliminating Duplicates")
    with open("cve.csv", "r") as in_f, open("cve_unduped.csv", "w", newline="") as out_f:
        seen = set()
        for line in in_f:
            if line in seen:
                continue
            seen.add(line)
            out_f.write(line)
    in_f.close()
    out_f.close()


def checkSearchDupes(searchTerms):
    print("Checking for Search Term Duplicates...")
    setTerms = set()
    for term in searchTerms:
        if term in setTerms:
            sys.exit("Found Duplicate Term: " + term)
        else:
            setTerms.add(term)
    print("No duplicate Search Terms found, moving on...")


def sendToTeams():
    print("Sending to Teams")
    # f = open('teams_hook.txt','r')
    # url = f.read()
    # f.close()
    url = os.getenv("TEAMS_HOOK")
    headers = {"Content-Type": "application/json"}
    payload = {
        "text": "New Report posted in Repo https://raw.githubusercontent.com/SecurityTapestry-Queen/nvd-cve-api-search/main/cves.xlsx"
    }
    r = requests.post(url, headers=headers, data=json.dumps(payload))
    print(r.text.encode("utf8"))
    # sys.exit('Done!')


def makeHtml():
    print('Making HTML')
    in_f = pd.read_csv('cve_unduped.csv', encoding='utf-8')
    in_f.to_html('cve_tables.html', index=False)
    print('Saved to output.html')

def csvExcel(csv, excel):
    df = pd.read_csv(csv)
    writer = pd.ExcelWriter(excel)
    df.to_excel(writer, index=False)
    writer.close()

def xlsxArchiver(excel):
    archivePath = "archive/"
    CST = pytz.timezone("America/Chicago")
    now = datetime.now(CST)
    date_time = now.strftime("%m-%d-%Y-%H-%M-%S")
    os.system("cp "+excel+" "+archivePath+"report-"+date_time+".xlsx")
    print("XLSX Archived to "+archivePath+"report-"+date_time+".xlsx")

kwArray = [
".NET","365",
"ADX","AMD","AWS","Adobe","Airflow","Airwatch","Amazon","Apache","Apple","Arris","Aruba","Atlassian","Azure","Atom","ASP.NET",
"BusyBox","biometric","bitcoin","Barracuda","Botnet",
"CSRF","Carbon Black","Cisco","Citrix","Crowdstrike","cryptocurrency","crypto",
"D-Link","Darktrace","Defender","Dell","Discourse","Django","Docker","Dolibarr","Debian","DDoS",
"EMC","ESXi","Eclipse","Elasticsearch","Ethereum","Excel","Exchange","Encyption","Exploit",
"Fortinet","Freshworks","FreshService","Firewall",
"GIS","GitLab","Go","Google","Gradle","Grafana","git",
"HP","Hadoop","HashiCorp","Hyper-V",
"IBM","IOBit","Intel","IoT",
"Java","Jenkins","JetBrains","Juniper","jQuery","Jira","JavaScript",
"Kibana","Kubernetes",
"Lenovo","Linux",
"MSI","Management","Mattermost","Microsoft","MongoDB","MySQL","macOS","MariaDB","Malware","MFA","Multi-factor Authentication",
"NVIDIA","Netgear","Nextcloud","Nginx","Node.js","NoSQL",
"OAuth","Office365","Okta","OpenSSL","Oracle","Outlook","Office",
"PHP","Palo Alto","Powerpoint","Proofpoint","Python","Phishing","PipeDrive",
"QEMU","QGIS",
"RDP","Rapid7","Red Canary","Red Hat","Redis","Ransomware","Rootkit",
"SAP","SNMP","SQL","SSL","STARTTLS","SUSE","SentinelOne","SharePoint","Slack","Snapdragon","Solarwinds","StarWind","samba","Spyware",
"TLS","Tenda","TensorFlow",
"Ubiquity","Ubuntu",
"VMware","VNC","VPN","Visual Studio",
"Win32k","Windows","Word","WordPress","Wyse",
"Xen","xterm",
"Zoho","Zoom","Zyxel",
]

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="NVD CVE API Scraper")
    parser.add_argument(
        "-m",
        "--mini-csv",
        help="Only checks for a few CVEs per Search Term",
        action="store_true",
        dest="Mini",
        default=False,
    )
    parser.add_argument(
        "-t",
        "--send-to-teams",
        help="Sends Link to Teams Channel",
        action="store_true",
        dest="SendToTeams",
        default=False,
    )
    parser.add_argument(
        "-html",
        "--html-tables",
        help="Converts Output CSV to HTML Tables",
        action="store_true",
        dest="MakeHtml",
        default=False,
    )
    parser.add_argument(
        "-e",
        "--excel",
        help="Converts final CSV to Excel file",
        action="store_true",
        dest="MakeExcel",
        default=False,
    )
    parser.add_argument(
        "-a",
        "--archiver",
        help="Archives XLSX",
        action="store_true",
        dest="Archiver",
        default=False
    )
    args = parser.parse_args()

    if sys.version_info < (3, 10):
        sys.exit("Please use Python 3.10+")
    print("Search Terms Used:")
    print(*kwArray, sep=", ")
    time.sleep(3)

    checkSearchDupes(kwArray)
    time.sleep(3)

    if args.Mini:
        print("Mini Mode On")
        csvWriter(True)
    else:
        csvWriter()
    dupeCheck()

    if args.SendToTeams:
        sendToTeams()

    if args.MakeHtml:
        makeHtml()

    if args.MakeExcel:
        csvExcel('cve_unduped.csv','cves.xlsx')

    if args.Archiver:
        xlsxArchiver("cves.xlsx")

    print('Done!')